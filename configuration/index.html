
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../free_energy/">
      
      
      
      <link rel="icon" href="../icon.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>setup & configuration - psiflow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="yellow">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python-environment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="psiflow" class="md-header__button md-logo" aria-label="psiflow" data-md-component="logo">
      
  <img src="../icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            psiflow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              setup & configuration
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/molmod/psiflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="psiflow" class="md-nav__button md-logo" aria-label="psiflow" data-md-component="logo">
      
  <img src="../icon.svg" alt="logo">

    </a>
    psiflow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/molmod/psiflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    atomic geometries
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hamiltonian/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hamiltonians
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sampling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sampling
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QM calculations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ML potentials
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    online learning
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../free_energy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    free energy calculations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    setup & configuration
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    setup & configuration
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#python-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Python environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ml-potential-training" class="md-nav__link">
    <span class="md-ellipsis">
      1. ML potential training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-molecular-dynamics" class="md-nav__link">
    <span class="md-ellipsis">
      2. molecular dynamics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-qm-calculations" class="md-nav__link">
    <span class="md-ellipsis">
      3. QM calculations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slurm-quickstart" class="md-nav__link">
    <span class="md-ellipsis">
      SLURM quickstart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-setup" class="md-nav__link">
    <span class="md-ellipsis">
      manual setup
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>setup & configuration</h1>

<p>Psiflow is easy to set up on most HPCs. The only requirement is a relatively recent
container engine:</p>
<ul>
<li>Apptainer &gt;= 1.2</li>
<li>SingularityCE &gt;= 3.11</li>
</ul>
<p>To detect which of these is available on your HPC, execute <code>apptainer --version</code> or
<code>singularity --version</code> in a shell on a login or compute node. Note that on some systems, the container runtime is packaged in a
module in which case you would first have to load it before it becomes available in your
shell. Check your HPC's documentation for more information.
If none of these are available, contact your system administrators or set up psiflow
<a href="#manual-setup">manually</a>. Otherwise, proceed with the following steps.</p>
<p>We provide two versions of essentially the same container; one for Nvidia GPUs (based on a
PyTorch wheel for CUDA 11.8) and one for AMD GPUs (based on a PyTorch wheel for ROCm 5.6).
These images are hosted on the Github Container Registry (abbreviated by <code>ghcr</code>) and can
be directly downloaded and cached by the container runtime.
For example, if we wish to execute a simple command <code>ls</code> using the container image for
Nvidia GPUs, we would write:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>oras://ghcr/io/molmod/psiflow:main_cu118<span class="w"> </span>ls
</code></pre></div>
We use <code>psiflow:main_cu118</code> to get the image which was built from the latest <code>main</code> branch
of the psiflow repository, for CUDA 11.8.
Similarly, for AMD GPUs and, for example, psiflow v4.0.0-rc0, we would use
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>oras://ghcr.io/molmod/psiflow:4.0.0-rc0_rocm5.6<span class="w"> </span>ls
</code></pre></div>
See the <a href="https://apptainer.org/docs/user/latest/">Apptainer</a>/<a href="https://docs.sylabs.io/guides/4.1/user-guide/">SingularityCE</a> documentation for more information.</p>
<h2 id="python-environment">Python environment</h2>
<p>The main Python script which defines the workflow requires a Python 3.10 / 3.11 environment
with a recent version of <code>pip</code> and <a href="https://github.com/cooperative-computing-lab/cctools"><code>ndcctools</code></a>.</p>
<ul>
<li>
<p><strong>(without existing conda/mamba binary)</strong>: if you do not know how to set this up yourself, use the following one-line install command:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>molmod.github.io/psiflow/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
</code></pre></div>
  This command sets up <code>micromamba</code> (i.e. <code>conda</code> but 1000x faster) in a fully local
  manner, without messing up your <code>.bashrc</code> or <code>.zshrc</code> file. In addition, it creates a
  minimal Python environment with all the required packages installed. Activate the
  environment by sourcing the <code>activate.sh</code> file which will have been created in the
  current working directory:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">source</span><span class="w"> </span>activate.sh
</code></pre></div></p>
</li>
<li>
<p><strong>(with existing conda binary)</strong>: create a new 3.10/3.11 environment and make sure <code>pip</code>
  and <code>ndcctools</code> are available:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>micromamba create -n psiflow_env -y python=3.10 pip ndcctools=7.11.1 -c conda-forge
</code></pre></div>
  Next, activate the environment and install psiflow from its repository:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>micromamba activate psiflow_env
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>pip install git+https://github.com/molmod/psiflow.git@v4.0.0-rc0
</code></pre></div>
<em>Everything else</em> -- i-PI, CP2K, GPAW, Weights &amp; Biases, PLUMED, ... -- is handled by
the container images and hence need not be installed manually.</p>
</li>
<li>
<p><strong>(with <code>virtualenv</code>/<code>venv</code>)</strong>: create a new environment and install psiflow from github
  using the same command as above. In addition, you will have to compile and install the <code>cctools</code>
  package manually. See the
  <a href="https://cctools.readthedocs.io/en/stable/install/">documentation</a> for the appropriate
  instructions.</p>
</li>
</ul>
<p>Verify the correctness of your environment using the following commands:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import psiflow&#39;</span><span class="w">  </span><span class="c1"># python import should work</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>which<span class="w"> </span>work_queue_worker<span class="w">     </span><span class="c1"># tests whether ndcctools is available and on PATH</span>
</code></pre></div>
<h2 id="execution">Execution</h2>
<p>Psiflow scripts are executed as a simple Python process.
Internally, it relies on Parsl to analyze the dependencies between different tasks and
execute the calculations asynchronously and as fast as possible.
To achieve this, it automatically requests the compute resources it needs during
execution.</p>
<p>To make this work, it is necessary to define precisely how ML potential training, molecular
dynamics, and QM calculations should proceed, and (ii)
how the required resources for those calculations should be obtained.
These additional parameters are to be specified in a separate 'configuration' <code>.yaml</code> file, which is
passed into the main Python workflow script as an argument.
The configuration file has a specific structure which is explained in the following
sections. In many cases, you will be able to start from one of the <a href="https://github.com/molmod/psiflow/tree/main/configs">example
configurations</a>
in the repository and adapt it for your cluster.
We also suggest you  to go through Parsl's <a href="https://parsl.readthedocs.io/en/stable/userguide/execution.html">documentation on
execution</a> first as this
will improve your understanding of what follows.</p>
<p>There are three types of calculations:</p>
<ul>
<li><strong>ML potential training</strong> (<code>ModelTraining</code>)</li>
<li><strong>ML potential inference, i.e. molecular dynamics</strong> (<code>ModelEvaluation</code>)</li>
<li><strong>QM calculations</strong> (<code>CP2K</code>, <code>GPAW</code>, <code>ORCA</code>)</li>
</ul>
<p>and the structure of a typical <code>config.yaml</code> consequently looks like this
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># top level options define the overall behavior</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># see below for a full list</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nt">container_engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;singularity or apptainer&gt;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nt">container_uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;link to container, i.e. oras://ghcr.io/...&gt;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="nt">ModelTraining</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="c1"># specifies how ML potential training should be performed</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">  </span><span class="c1"># and which resources it needs to use</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="nt">ModelEvaluation</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">  </span><span class="c1"># specifies how MD / geometry optimization / hamiltonian computations are performed</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="c1"># and which resources it needs to use</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="nt">CP2K</span><span class="p">:</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">  </span><span class="c1"># specifies how CP2K single points need to be performed</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="nt">GPAW</span><span class="p">:</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">  </span><span class="c1"># specifies how GPAW single points need to be performed</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="nt">ORCA</span><span class="p">:</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">  </span><span class="c1"># specifies how ORCA single points need to be performed</span>
</code></pre></div></p>
<h3 id="1-ml-potential-training">1. ML potential training</h3>
<p>This defines how <code>model.train()</code> operations are performed. Since
training is necessarily performed on a GPU, it is necessary to specify resources in
which a GPU is available. Consider the following simple training example
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span> <span class="nn">psiflow</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span> <span class="nn">psiflow.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">from</span> <span class="nn">psiflow.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">fraction</span><span class="p">):</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;my_previous_model&#39;</span><span class="p">)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="n">train</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;data.xyz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fraction_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fraction</span><span class="p">))</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="k">with</span> <span class="n">psiflow</span><span class="o">.</span><span class="n">load</span><span class="p">():</span>    <span class="c1"># ensures script waits until everything completes</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="n">main</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        <span class="n">main</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="n">main</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</code></pre></div>
It will execute three independent training runs, whereby the only difference is in the
fraction of training and validation data. Importantly, because their is no dependency
between each individual run, they will automatically be executed in parallel.
Suppose we are in a terminal on e.g. a login or compute node of a SLURM cluster.
Then we can execute the script using the following command:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>python<span class="w"> </span>train.py<span class="w"> </span>config.yaml
</code></pre></div>
The <code>config.yaml</code> file should define how and where the model should be trained and
evaluated.</p>
<p>Next, we define how model training should be performed.
Internally, Parsl will use that information to construct the appropriate
SLURM jobscripts, send them to the scheduler, and once the resources are allocated,
start the calculation. For example, assume that the GPU partition on this cluster is
named <code>infinite_a100</code>, and it has 12 cores per GPU. Consider the following config
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">ModelTraining</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="nt">cores_per_worker</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">  </span><span class="nt">gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span><span class="nt">slurm</span><span class="p">:</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="nt">partition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;infinite_a100&quot;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="nt">account</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;112358&quot;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="nt">nodes_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="nt">cores_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="nt">max_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="nt">walltime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12:00:00&quot;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="nt">scheduler_options</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#SBATCH</span><span class="nv"> </span><span class="s">--gpus=2&quot;</span>
</code></pre></div>
The top-level keyword <code>ModelTraining</code> indicates that we're defining the execution of
<code>model.train()</code>. It has a number of special keywords:</p>
<ul>
<li><strong>cores_per_worker</strong> (int): number of CPUs per GPU.</li>
<li><strong>gpu</strong> (bool): whether to use GPU(s) -- should almost always be true for training.</li>
<li><strong>slurm</strong> (dict): defines compute resources specifically for a SLURM scheduler (i.e.
    using <code>sbatch</code>/<code>salloc</code> commands). It should include all parameters which are
    required to create the actual jobscript. Note that the requested resources for a single slurm job
    can be larger than the required resources per worker.
    In this particular example, we ask for a single allocation of 2 GPUs and 24 cores in
    total, with a walltime of 12 hours, and with a limit on the number of running jobs of
    this type equal to 1 (<code>max_blocks</code>).</li>
</ul>
<p>When we execute <code>python train.py config.yaml</code>, psiflow will analyze the script and
realize it needs to execute three training runs. Because we use <code>cores_per_worker:
12</code>, it sees that it can fit all three training runs on two SLURM jobs, each with two GPUs.
Of course, because <code>max_blocks: 1</code>, it will only submit one job and start two training
runs. The third training run will start only when any of the first two have finished running,
he will not submit a second SLURM job. The <code>max_blocks</code> setting is useful in scenarios
where your cluster imposes tight limits on the number of running jobs per user, or when
the queue time is long.</p>
<p>There exist a few additional keywords for <code>ModelTraining</code> which might be useful:</p>
<ul>
<li><strong>max_training_time</strong> (float, in minutes): This is the maximum time that any
    single training run can take. After this time, a <code>SIGTERM</code> is sent to the training
    process which ensures the training is gracefully interrupted and output models
    are saved. Sometimes, it is more convenient to use this rather than MACE's built
    in <code>max_num_epochs</code> parameter.</li>
<li><strong>env_vars</strong> (dict): additional environment variables which might be necessary to
    achieve optimal training performance. For example, on some clusters, it is
    necessary to tune the process/thread affinity a little bit. For example:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">env_vars</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="nt">OMP_PROC_BIND</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;spread&quot;</span>
</code></pre></div></li>
</ul>
<h3 id="2-molecular-dynamics">2. molecular dynamics</h3>
<p>Consider the following example:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span> <span class="nn">psiflow</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span> <span class="nn">psiflow.sampling</span> <span class="kn">import</span> <span class="n">Walker</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">replica_exchange</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span> <span class="nn">psiflow.geometry</span> <span class="kn">import</span> <span class="n">Geometry</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kn">from</span> <span class="nn">psiflow.hamiltonians</span> <span class="kn">import</span> <span class="n">MACEHamiltonian</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="n">mace</span> <span class="o">=</span> <span class="n">MACEHamiltonian</span><span class="o">.</span><span class="n">mace_mp0</span><span class="p">()</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="n">start</span> <span class="o">=</span> <span class="n">Geometry</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;start.xyz&#39;</span><span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">walkers</span> <span class="o">=</span> <span class="n">Walker</span><span class="p">(</span><span class="n">mace</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>   <span class="c1"># extremely long</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="n">output</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.xyz&#39;</span><span class="p">)</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="k">with</span> <span class="n">psiflow</span><span class="o">.</span><span class="n">load</span><span class="p">():</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="n">main</span><span class="p">()</span>
</code></pre></div>
In this example, we use MACE-MP0 to run 8 molecular dynamics simulations in the NVT
ensemble. Since they are all independent from each other, psiflow will attempt to execute
them in parallel as much as possible.
The configuration section which deals with ML potential inference, including molecular
dynamics but also geometry optimization and <code>hamiltonian.compute()</code> calls, is named
<code>ModelEvaluation</code>:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nt">ModelEvaluation</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="nt">cores_per_worker</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="nt">gpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span><span class="nt">slurm</span><span class="p">:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nt">partition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;infinite_a100&quot;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nt">account</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;112358&quot;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="nt">nodes_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="nt">cores_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">48</span><span class="w">          </span><span class="c1"># full node; sometimes granted faster than partials</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="nt">max_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="nt">walltime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;01:00:00&quot;</span><span class="w">        </span><span class="c1"># small to try and skip the queue</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="nt">scheduler_options</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#SBATCH</span><span class="nv"> </span><span class="s">--gpus=4&quot;</span>
</code></pre></div>
It is in general quite similar to <code>ModelTraining</code>. Because in general, psiflow workflows
contain a large number of molecular dynamics simulations, it makes sense to ask for larger
allocations for each block (= SLURM job). In this example, we immediately ask for two full
GPU nodes, with four GPUs each. This is exactly the amount we need to execute all eight
molecular dynamics simulations in parallel, without wasting any resources.
As such, when we execute the above example using <code>python script.py config.yaml</code>, Parsl
will recognize that we need resources for eight simulations, ask for precisely one allocation
according to the above parameters, and start all eight simulations simultaneously.</p>
<p>Of course, we greatly overestimate the number of steps we wish to simulate.
The SLURM allocation has a walltime of one hour, which means that if a simulation does not
finish in 12 hours, it will be gracefully terminated and the saved trajectories will only
cover a fraction of the requested one billion steps.
Psiflow will not automatically continue the simulations on a new SLURM allocation.</p>
<p>The available keywords in the <code>ModelEvaluation</code> section are the same as for
<code>ModelTraining</code>, except for one:</p>
<ul>
<li><strong>max_simulation_time</strong> (float, in minutes): </li>
</ul>
<h3 id="3-qm-calculations">3. QM calculations</h3>
<p>Finally, we need to specify how QM calculations are performed.
By default, these calculations are not executed within the container image provided by
<code>container_uri</code> at the top level.
Users can choose to rely on their system-installed QM software or employ one of the
smaller and specialized container images for CP2K or GPAW. We will discuss both cases
below.</p>
<p>First, assume we wish to use a system-installed CP2K module, and execute each singlepoint
on 32 cores. Assume that the nodes in our cpu partition possess 128 cores:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">CP2K</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nt">cores_per_worker</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span><span class="nt">max_evaluation_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w">       </span><span class="c1"># kill calculation after 30 mins; SCF unconverged</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nt">launch_command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OMP_NUM_THREADS=1</span><span class="nv"> </span><span class="s">mpirun</span><span class="nv"> </span><span class="s">-np</span><span class="nv"> </span><span class="s">32</span><span class="nv"> </span><span class="s">cp2k.psmp&quot;</span><span class="w">  </span><span class="c1"># force 1 thread/rank</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">  </span><span class="nt">slurm</span><span class="p">:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="nt">partition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;infinite_CPU&quot;</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="nt">account</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;112358&quot;</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="nt">nodes_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="nt">cores_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="nt">max_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="nt">walltime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12:00:00&quot;</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="nt">worker_init</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ml</span><span class="nv"> </span><span class="s">CP2K/2024.1&quot;</span><span class="w">  </span><span class="c1"># activate CP2K module in jobscript!</span>
</code></pre></div>
We asked for a big allocation of 16 nodes, each with 128 cores. On each node, psiflow can
concurrently execute four singlepoints, since we specified <code>cores_per_worker: 32</code>.</p>
<p>Consider now the following script:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">import</span> <span class="nn">psiflow</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span> <span class="nn">psiflow.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span> <span class="nn">psiflow.reference</span> <span class="kn">import</span> <span class="n">CP2K</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="n">unlabeled</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;long_trajectory.xyz&#39;</span><span class="p">)</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cp2k_input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="n">cp2k_input</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">cp2k</span> <span class="o">=</span> <span class="n">CP2K</span><span class="p">(</span><span class="n">cp2k_input</span><span class="p">)</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="n">labeled</span> <span class="o">=</span> <span class="n">unlabeled</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cp2k</span><span class="p">)</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">labeled</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;labeled.xyz&#39;</span><span class="p">)</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="k">with</span> <span class="n">psiflow</span><span class="o">.</span><span class="n">load</span><span class="p">():</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        <span class="n">main</span><span class="p">()</span>
</code></pre></div>
Assume <code>long_trajectory.xyz</code> is a large XYZ file with, say, 1,000 snapshots.
In the above script, we simply load the data, evaluate the energy and forces of each
snapshot with CP2K, and save the result as (ext)XYZ.
Again, we execute this script by running <code>python script.py config.yaml</code> within a Python
environment with psiflow and cctools available.
Even though all of these calculations can proceed in parallel, we specified <code>max_blocks:
1</code> to not overload our resource usage.
As such, Parsl will request precisely one block/allocation of 16 nodes, and start
executing the singlepoint QM evaluations.
At any given moment, there will be (16 nodes x 4 calculations/node = ) 64 calculations
running.</p>
<p>Now assume our system administrators did not provide us with the latest and greatest
version of CP2K.
The installation process is quite long and tedious (even via tools like EasyBuild or Spack),
which is why psiflow provides <strong>small containers which only contain the QM software</strong>.
They are separate from the psiflow containers mentioned before in order to improve
modularity and reduce individual container sizes.
At the moment, such containers are available for CP2K 2024.1 and GPAW 24.1.
To use them, it suffices to wrap the launch command inside an <code>apptainer</code> or <code>singularity</code>
invocation, whichever is available on your system:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">CP2K</span><span class="p">:</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="nt">cores_per_worker</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span><span class="nt">max_evaluation_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w">       </span><span class="c1"># kill calculation after 30 mins; SCF unconverged</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">launch_command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;apptainer</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">--no-init</span><span class="nv"> </span><span class="s">oras://ghcr.io/molmod/cp2k:2024.1</span><span class="nv"> </span><span class="s">/opt/entry.sh</span><span class="nv"> </span><span class="s">mpirun</span><span class="nv"> </span><span class="s">-np</span><span class="nv"> </span><span class="s">32</span><span class="nv"> </span><span class="s">cp2k.psmp&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">  </span><span class="nt">slurm</span><span class="p">:</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="nt">partition</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;infinite_CPU&quot;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="nt">account</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;112358&quot;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="nt">nodes_per_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="nt">cores_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="nt">max_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="nt">walltime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;12:00:00&quot;</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="c1"># no more need for module load commands!</span>
</code></pre></div>
The command is quite long but normally self-explanatory if you're somewhat familiar with
containers.</p>
<h2 id="slurm-quickstart">SLURM quickstart</h2>
<p>Psiflow contains a small script which detects the available SLURM partitions and their
hardware and creates a minimal, initial <code>config.yaml</code> which you can use as a starting point
to further tune to your liking. To use it, simply activate your psiflow Python environment 
and execute the following command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import psiflow; psiflow.setup_slurm_config()&#39;</span>
</code></pre></div>
<h2 id="manual-setup">manual setup</h2>
<p>TODO</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.sections", "navigation.expand", "toc.integrate", "toc.follow"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>