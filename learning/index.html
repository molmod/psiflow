
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../models/">
      
      
        <link rel="next" href="../free_energy/">
      
      
      <link rel="icon" href="../icon.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>online learning - psiflow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="yellow">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#passive-learning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="psiflow" class="md-header__button md-logo" aria-label="psiflow" data-md-component="logo">
      
  <img src="../icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            psiflow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              online learning
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/molmod/psiflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="psiflow" class="md-nav__button md-logo" aria-label="psiflow" data-md-component="logo">
      
  <img src="../icon.svg" alt="logo">

    </a>
    psiflow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/molmod/psiflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    atomic geometries
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hamiltonian/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hamiltonians
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sampling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sampling
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QM calculations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ML potentials
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    online learning
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    online learning
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#passive-learning" class="md-nav__link">
    <span class="md-ellipsis">
      passive learning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#active-learning" class="md-nav__link">
    <span class="md-ellipsis">
      active learning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restarting-a-run" class="md-nav__link">
    <span class="md-ellipsis">
      restarting a run
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../free_energy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    free energy calculations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    setup & configuration
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>online learning</h1>

<p>Psiflow allows for the seamless development and scalable
execution of online learning algorithms for ML potentials.
The <code>Learning</code> class provides an interface based on which such
algorithms can be implemented.
They keep track of the generated data, error metrics, optional <a href="https://wandb.ai">Weights &amp;
Biases</a> logging, and provide basic restart functionalities in case
something goes wrong.
Learning objects are instantiated using the following arguments:</p>
<ul>
<li><strong>reference</strong> (type <code>Reference</code>): the <code>Reference</code> instance which will be used to
  evaluate ground-truth energy/force labels for each of the samples generated.</li>
<li><strong>path_output</strong> (type <code>str | Path</code>): the location to a folder in which intermediate
  models, datasets, walker states, and restart files can be saved.</li>
<li><strong>train_valid_split</strong> (type <code>float</code>): fraction of generated data which should be used
  for the training set (as opposed to validation).</li>
<li><strong>error_thresholds_for_reset</strong> (type <code>list[Optional[float]]</code>): during online learning,
  it is not uncommon to have walkers explore unphysical regions in phase space due to
  irregularities in the intermediate potential, excessive temperatures/pressures, ...
  In those cases, it is beneficial to reset walkers to their starting configurations, of
  which it is known to be a physically sound starting point. The decision to reset walkers
  is made every time the 'exact' energy and forces have been computed from a sampled
  state. If the error between the corresponding walker's model (i.e. the previous model)
  and the QM-evaluated energy and forces exceeds a certain threshold (both on energies and
  forces), the walker is reset.
  This argument expects a list of length two (threshold on energy error, and threshold on
  force error), with optional <code>None</code> values if no reset is desired.
  For example: <code>[None, 0.1]</code> indicates to reset whenever the force RMSE exceeds 100 meV/A,
  and ignore any energy discrepancy.</li>
<li><strong>error_thresholds_for_discard</strong> (type <code>list[Optional[float]]</code>): states which are
  entirely unphysical do not contribute to the accuracy of the model, and sometimes even
  hinder proper training. If these error thresholds are exceeded, the state is discarded and the walker is reset.</li>
<li><strong>wandb_group</strong> (type <code>str</code>): if specified, the computed dataset metrics will be logged
  to Weights &amp; Biases in the corresponding group of runs for easy visual analysis.</li>
<li><strong>wandb_project</strong> (type <code>str</code>): if specified, the computed dataset metrics will be logged
  to Weights &amp; Biases in the corresponding project for easy visual analysis.</li>
<li><strong>initial_data</strong> (type <code>Dataset</code>): existing, labeled data from which the learning can be
  bootstrapped. Note that <em>all</em> states in this dataset must be labeled, and that this is
  only sensible if the labeling agrees with the given Reference instance. (Same level of
  theory, same basis set, grid settings, ... ).</li>
</ul>
<figure>
  <img alt="Image title" src="../wandb.png" width="900" />
  <figcaption> Illustration of what the Weights &amp; biases logging looks like.
  The graph on top simply shows the force RMSE on each data point versus a unique
    'identifier' per data point. The bottom plot shows the same data points, but now
    grouped according to which walker generated them. In this case, walkers were sorted
    according to temperature (lower walker index were lower temperature), and this is seen
    in the fact that walkers with a higher index generated data with on average higher errors,
  as they explored more out-of-equilibrium configurations.</figcaption>
</figure>
<p>The core business of a <code>Learning</code> instance is the following sequence of operations:</p>
<ol>
<li>use walkers in a <code>sample()</code> call to generate atomic geometries</li>
<li>evaluate those atomic geometries with the provided reference to obtain QM energy and
   forces</li>
<li>include those geometries to the training data, or discard them if they exceed
   <code>error_thresholds_for_discard</code>. Reset walkers if they exceed
   <code>error_thresholds_for_reset</code>.</li>
<li>Train the model using the new data.</li>
<li>Compute metrics for the trained model across the new dataset and optionally log them to
   W&amp;B.</li>
</ol>
<p>Currently, there are two variants of this implemented: passive and active learning.</p>
<h2 id="passive-learning">passive learning</h2>
<p>During passive learning, walkers are propagated using an external and 'fixed' Hamiltonian
which is not trained at any point (e.g. a pre-trained universal potential or a
hessian-based Hamiltonian).</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">model</span><span class="p">,</span> <span class="n">walkers</span> <span class="o">=</span> <span class="n">learning</span><span class="o">.</span><span class="n">passive_learning</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">walkers</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">hamiltonian</span><span class="o">=</span><span class="n">MACEHamiltonian</span><span class="o">.</span><span class="n">mace_mp0</span><span class="p">(),</span>     <span class="c1"># fixed hamiltonian</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">steps</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">step</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="o">**</span><span class="n">optional_sampling_kwargs</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span>
</code></pre></div>
Walkers are propagated for a total of 20,000 steps, and samples are drawn every 2,000
steps which are QM evaluated by the reference and added to the training data.
If the walkers contain bias contributions, their total hamiltonian is simply the sum of
the existing bias contributions and the hamiltonian given to the <code>passive_learning()</code>
call.
Additional keyword arguments to this function are passed directly into the sample function (e.g. for
specifying the log level or the center-of-mass behavior). </p>
<p>The returned model is the one trained on all data generated in the <code>passive_learning()</code> call as well as all data which was already present in the learning instance (for example if it had been initialized with <code>initial_data</code>, see above).
The returned walkers are identical to the ones passed into the method, but this is done to
emphasize that internally, they do change due to calling <code>passive_learning</code> (because they
are either propagated or reset, or their metadynamics bias has changed because there are
more hills present than before).</p>
<h2 id="active-learning">active learning</h2>
<p>During active learning, walkers are propagated with a Hamiltonian generated using the
current model. They are propagated for a given number of steps after which their final
state is passed into the reference for correct labeling.
Different from passive learning, active learning <em>does not allow for subsampling of the
trajectories of the walkers</em>. The idea behind this is that if you wish to propagate the
walker for 10 ps, and sample a structure every 1 ps to let each walker generate 10 states,
it is likely much better to instead increase the number of walkers (to cover more regions
in phase space) and propagate them in steps of 1 ps. Active learning is ideally suited for
massively parallel workflows (maximal number of walkers, with minimal sampling time per
walker) and we encourage users to exploit this.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">model</span><span class="p">,</span> <span class="n">walkers</span> <span class="o">=</span> <span class="n">learning</span><span class="o">.</span><span class="n">active_learning</span><span class="p">(</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="n">model</span><span class="p">,</span>                      <span class="c1"># used to generate hamiltonian</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">walkers</span><span class="p">,</span>      
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="n">steps</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>                 <span class="c1"># no more &#39;step&#39; argument!</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="o">**</span><span class="n">optional_sampling_kwargs</span><span class="p">,</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="p">)</span>
</code></pre></div>
<h2 id="restarting-a-run">restarting a run</h2>
<p><code>Learning</code> has first-class support for restarted runs -- simply resubmit your calculation!
It will detect whether or not the corresponding output folder has already fully logged the
each of the iterations, and if so, load the final state of the model, the walkers, and the
learning instance without actually doing any calculations.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.sections", "navigation.expand", "toc.integrate", "toc.follow"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>