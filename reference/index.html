
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../sampling/">
      
      
        <link rel="next" href="../models/">
      
      
      <link rel="icon" href="../icon.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>QM calculations - psiflow</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="yellow">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#qm-calculations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="psiflow" class="md-header__button md-logo" aria-label="psiflow" data-md-component="logo">
      
  <img src="../icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            psiflow
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              QM calculations
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/molmod/psiflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="psiflow" class="md-nav__button md-logo" aria-label="psiflow" data-md-component="logo">
      
  <img src="../icon.svg" alt="logo">

    </a>
    psiflow
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/molmod/psiflow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    atomic geometries
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hamiltonian/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hamiltonians
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sampling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sampling
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    QM calculations
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    QM calculations
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cp2k-20241" class="md-nav__link">
    <span class="md-ellipsis">
      CP2K 2024.1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpaw-241" class="md-nav__link">
    <span class="md-ellipsis">
      GPAW 24.1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#orca" class="md-nav__link">
    <span class="md-ellipsis">
      ORCA
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ML potentials
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    online learning
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../free_energy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    free energy calculations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    setup & configuration
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="qm-calculations">QM calculations</h1>
<p>The energy and gradients of the ground-state Born-Oppenheimer surface can be obtained
using varying levels of approximation.
In psiflow, the calculation of the energy and its gradients can be performed for both
<code>Geometry</code> and <code>Dataset</code> instances, using different software packages:</p>
<ul>
<li><strong>CP2K</strong> (periodic, mixed PW/lcao): very fast, and very useful for pretty much any periodic
  structure. Its forces tend to be quite noisy with the default grid settings so some
  level of caution is advised. Also, even though it uses both plane waves and atomic basis
  sets, it does suffer from BSSE.</li>
<li><strong>GPAW</strong> (periodic/cluster, PW/lcao/grid): slower but more numerically stable than CP2K;
  essentially a fully open-source (and therefore transparant), free, and well-tested
  alternative to VASP. Particularly useful for applications in which BSSE is a concern
  (e.g. adsorption).</li>
<li><strong>ORCA</strong> (cluster, lcao): useful for accurate high-level quantum chemistry calculations,
  e.g. MP2 and CCSD(T). <em>TODO</em></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Installation</p>
<p>Because the 'correct' compilation and installation of quantum chemistry software is
notoriously cumbersome, we host separate container images for each of the packages
on Github, which are ready to use with psiflow on HPCs with either a Singularity
or Apptainer container runtime. The Docker files used to generate those images are
available in the respository; 
<a href="https://github.com/molmod/psiflow/blob/main/Dockerfile.cp2k">CP2K</a> or
<a href="https://github.com/molmod/psiflow/blob/main/Dockerfile.gpaw">GPAW</a>.
See the <a href="../configuration/">configuration</a> section for more details.</p>
</div>
<p>For each software package, psiflow provides a corresponding class which implements
the appropriate input file manipulations, launch commands, and output parsing
functionalities.
They all inherit from the <code>Reference</code> base class, which provides a few key
functionalities:</p>
<ul>
<li><code>data.evaluate(reference)</code>: this is the most common operation involving QM calculations;
  given a <code>Dataset</code> of atomic geometries, compute the energy and its gradients and insert
  them into the dataset such that they are saved for future reuse.</li>
<li><code>reference.compute_atomic_energy</code>: provides the ability to compute isolated atom
  reference energies, as this facilitates ML potential training to datasets with varying
  number of atoms.</li>
<li><code>reference.compute(data)</code>: this is somewhat equivalent to the hamiltonian <code>compute</code>
  method, except that its argument <code>data</code> must be a <code>Dataset</code> instance, and the optional
  <code>batch_size</code> defaults to 1 (in order to maximize parallelization). It does not insert
  the computed properties into the data, but returns them as numpy arrays.</li>
</ul>
<p>From a distance, QM reference objects look almost identical to hamiltonians, in the sense
that they both take atomic geometries as input and return energies and gradients as
output. The (imposed) distinction between both can be summarized in the following points.</p>
<ul>
<li>hamiltonians can compute energies and forces for pretty much <em>any</em> structure. There is
  no reason they would fail. QM calculations on the other hand can fail due to unconverged
  SCF cycles and/or time limit constraints. In fact, this happens relatively often when performing
  active learning workflows. Reference objects take this into account by returning a unique
  <code>NullState</code> whenever a calculation has failed.</li>
<li>hamiltonians are orders of magnitude faster, and can be employed in meaningfully long
  molecular dynamics simulations. This is not the case for QM calculations. As such, they
  cannot be used in combination with walker sampling or geometry optimizations. If the
  purpose is to perform molecular simulation at the DFT level, then the better approach is
  to train an ML potential to any desired level of accuracy (almost always possible in
  psiflow) and use that as proxy for the QM interaction energy.
  For the same reason, the default batch size for <code>reference.compute</code> calls is 1, i.e.
  each the QM calculation for each structure in the dataset is immediately scheduled
  independently from the other ones.
  With hamiltonians, that batch size defaults to 100 (split data in chunks of 100 and
  evaluate each set of 100 states serially).</li>
</ul>
<h2 id="cp2k-20241">CP2K 2024.1</h2>
<p>A <code>CP2K</code> reference instance can be created based on a (multiline) input string.
Only the <code>FORCE_EVAL</code> section of the input is important since the atomic coordinates and cell
parameters are automatically inserted for every calculation.
All basis set, pseudopotential, and D3 parameters from the official
<a href="https://github.com/cp2k/cp2k">CP2K repository</a> are directly available in the
container image (i.e. no need to download or provide these files separately).
Choose which one you would like to use by using the corresponding filename in the input
file (i.e. omit any preceding filepaths).
A typical <a href="https://github.com/molmod/psiflow/blob/main/examples/data/cp2k_input.txt">input file</a>
is provided in the <a href="https://github.com/molmod/psiflow/tree/main/examples">examples</a>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span> <span class="nn">psiflow.reference</span> <span class="kn">import</span> <span class="n">CP2K</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># create reference instance</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cp2k_input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">force_eval_input_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="n">cp2k</span> <span class="o">=</span> <span class="n">CP2K</span><span class="p">(</span><span class="n">force_eval_input_str</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="c1"># compute energy and forces, and store them in the geometries</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="n">evaluated_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cp2k</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="k">for</span> <span class="n">geometry</span> <span class="ow">in</span> <span class="n">evaluated_data</span><span class="o">.</span><span class="n">geometries</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="p">():</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;energy: </span><span class="si">{}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">energy</span><span class="p">))</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;forces: </span><span class="si">{}</span><span class="s1"> eV/A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">geometry</span><span class="o">.</span><span class="n">per_atom</span><span class="o">.</span><span class="n">forces</span><span class="p">))</span>
</code></pre></div>
<h2 id="gpaw-241">GPAW 24.1</h2>
<p>a <code>GPAW</code> reference is created in much the same way as a traditional <code>GPAW</code> 'calculator'
instance, with support for entirely the same keyword arguments:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span> <span class="nn">psiflow.reference</span> <span class="kn">import</span> <span class="n">GPAW</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">gpaw</span> <span class="o">=</span> <span class="n">GPAW</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fd&#39;</span><span class="p">,</span> <span class="n">nbands</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xc</span><span class="o">=</span><span class="s1">&#39;PBE&#39;</span><span class="p">)</span>  <span class="c1"># see GPAW calculator on gitlab for full list</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">energies</span> <span class="o">=</span> <span class="n">gpaw</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">)</span>
</code></pre></div>
A notable feature from GPAW is that it already outputs all energies as formation energies,
i.e. it internally subtracts the sum of the energies of the isolated atoms. As such, the
<code>compute_atomic_energy</code> for a GPAW reference always just returns 0 eV.</p>
<h2 id="orca">ORCA</h2>
<p>TODO</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.sections", "navigation.expand", "toc.integrate", "toc.follow"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>